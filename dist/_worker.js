var Ur=Object.defineProperty;var At=e=>{throw TypeError(e)};var qr=(e,t,r)=>t in e?Ur(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var v=(e,t,r)=>qr(e,typeof t!="symbol"?t+"":t,r),st=(e,t,r)=>t.has(e)||At("Cannot "+r);var u=(e,t,r)=>(st(e,t,"read from private field"),r?r.call(e):t.get(e)),x=(e,t,r)=>t.has(e)?At("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),w=(e,t,r,n)=>(st(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),O=(e,t,r)=>(st(e,t,"access private method"),r);var Rt=(e,t,r,n)=>({set _(s){w(e,t,s,r)},get _(){return u(e,t,n)}});var nr={Stringify:1},$=(e,t)=>{const r=new String(e);return r.isEscaped=!0,r.callbacks=t,r},Br=/[&<>'"]/,sr=async(e,t)=>{let r="";t||(t=[]);const n=await Promise.all(e);for(let s=n.length-1;r+=n[s],s--,!(s<0);s--){let i=n[s];typeof i=="object"&&t.push(...i.callbacks||[]);const o=i.isEscaped;if(i=await(typeof i=="object"?i.toString():i),typeof i=="object"&&t.push(...i.callbacks||[]),i.isEscaped??o)r+=i;else{const a=[r];te(i,a),r=a[0]}}return $(r,t)},te=(e,t)=>{const r=e.search(Br);if(r===-1){t[0]+=e;return}let n,s,i=0;for(s=r;s<e.length;s++){switch(e.charCodeAt(s)){case 34:n="&quot;";break;case 39:n="&#39;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}t[0]+=e.substring(i,s)+n,i=s+1}t[0]+=e.substring(i,s)},ir=e=>{const t=e.callbacks;if(!(t!=null&&t.length))return e;const r=[e],n={};return t.forEach(s=>s({phase:nr.Stringify,buffer:r,context:n})),r[0]},or=async(e,t,r,n,s)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));const i=e.callbacks;return i!=null&&i.length?(s?s[0]+=e:s=[e],Promise.all(i.map(a=>a({phase:t,buffer:s,context:n}))).then(a=>Promise.all(a.filter(Boolean).map(l=>or(l,t,!1,n,s))).then(()=>s[0]))):Promise.resolve(e)},zr=(e,...t)=>{const r=[""];for(let n=0,s=e.length-1;n<s;n++){r[0]+=e[n];const i=Array.isArray(t[n])?t[n].flat(1/0):[t[n]];for(let o=0,a=i.length;o<a;o++){const l=i[o];if(typeof l=="string")te(l,r);else if(typeof l=="number")r[0]+=l;else{if(typeof l=="boolean"||l===null||l===void 0)continue;if(typeof l=="object"&&l.isEscaped)if(l.callbacks)r.unshift("",l);else{const c=l.toString();c instanceof Promise?r.unshift("",c):r[0]+=c}else l instanceof Promise?r.unshift("",l):te(l.toString(),r)}}}return r[0]+=e.at(-1),r.length===1?"callbacks"in r?$(ir($(r[0],r.callbacks))):$(r[0]):sr(r,r.callbacks)},wt=Symbol("RENDERER"),pt=Symbol("ERROR_HANDLER"),A=Symbol("STASH"),ar=Symbol("INTERNAL"),Kr=Symbol("MEMO"),Ze=Symbol("PERMALINK"),_t=e=>(e[ar]=!0,e),lr=e=>({value:t,children:r})=>{if(!r)return;const n={children:[{tag:_t(()=>{e.push(t)}),props:{}}]};Array.isArray(r)?n.children.push(...r.flat()):n.children.push(r),n.children.push({tag:_t(()=>{e.pop()}),props:{}});const s={tag:"",props:n,type:""};return s[pt]=i=>{throw e.pop(),i},s},cr=e=>{const t=[e],r=lr(t);return r.values=t,r.Provider=r,be.push(r),r},be=[],bt=e=>{const t=[e],r=n=>{t.push(n.value);let s;try{s=n.children?(Array.isArray(n.children)?new hr("",{},n.children):n.children).toString():""}finally{t.pop()}return s instanceof Promise?s.then(i=>$(i,i.callbacks)):$(s)};return r.values=t,r.Provider=r,r[wt]=lr(t),be.push(r),r},Ce=e=>e.values.at(-1),qe={title:[],script:["src"],style:["data-href"],link:["href"],meta:["name","httpEquiv","charset","itemProp"]},mt={},Be="data-precedence",Me=e=>Array.isArray(e)?e:[e],Tt=new WeakMap,Lt=(e,t,r,n)=>({buffer:s,context:i})=>{if(!s)return;const o=Tt.get(i)||{};Tt.set(i,o);const a=o[e]||(o[e]=[]);let l=!1;const c=qe[e];if(c.length>0){e:for(const[,f]of a)for(const h of c)if(((f==null?void 0:f[h])??null)===(r==null?void 0:r[h])){l=!0;break e}}if(l?s[0]=s[0].replaceAll(t,""):c.length>0?a.push([t,r,n]):a.unshift([t,r,n]),s[0].indexOf("</head>")!==-1){let f;if(n===void 0)f=a.map(([h])=>h);else{const h=[];f=a.map(([d,,g])=>{let E=h.indexOf(g);return E===-1&&(h.push(g),E=h.length-1),[d,E]}).sort((d,g)=>d[1]-g[1]).map(([d])=>d)}f.forEach(h=>{s[0]=s[0].replaceAll(h,"")}),s[0]=s[0].replace(/(?=<\/head>)/,f.join(""))}},De=(e,t,r)=>$(new H(e,r,Me(t??[])).toString()),Fe=(e,t,r,n)=>{if("itemProp"in r)return De(e,t,r);let{precedence:s,blocking:i,...o}=r;s=n?s??"":void 0,n&&(o[Be]=s);const a=new H(e,o,Me(t||[])).toString();return a instanceof Promise?a.then(l=>$(a,[...l.callbacks||[],Lt(e,l,o,s)])):$(a,[Lt(e,a,o,s)])},Vr=({children:e,...t})=>{const r=xt();if(r){const n=Ce(r);if(n==="svg"||n==="head")return new H("title",t,Me(e??[]))}return Fe("title",e,t,!1)},Jr=({children:e,...t})=>{const r=xt();return["src","async"].some(n=>!t[n])||r&&Ce(r)==="head"?De("script",e,t):Fe("script",e,t,!1)},Gr=({children:e,...t})=>["href","precedence"].every(r=>r in t)?(t["data-href"]=t.href,delete t.href,Fe("style",e,t,!0)):De("style",e,t),Xr=({children:e,...t})=>["onLoad","onError"].some(r=>r in t)||t.rel==="stylesheet"&&(!("precedence"in t)||"disabled"in t)?De("link",e,t):Fe("link",e,t,"precedence"in t),Zr=({children:e,...t})=>{const r=xt();return r&&Ce(r)==="head"?De("meta",e,t):Fe("meta",e,t,!1)},ur=(e,{children:t,...r})=>new H(e,r,Me(t??[])),Yr=e=>(typeof e.action=="function"&&(e.action=Ze in e.action?e.action[Ze]:void 0),ur("form",e)),fr=(e,t)=>(typeof t.formAction=="function"&&(t.formAction=Ze in t.formAction?t.formAction[Ze]:void 0),ur(e,t)),Qr=e=>fr("input",e),en=e=>fr("button",e);const it=Object.freeze(Object.defineProperty({__proto__:null,button:en,form:Yr,input:Qr,link:Xr,meta:Zr,script:Jr,style:Gr,title:Vr},Symbol.toStringTag,{value:"Module"}));var tn=new Map([["className","class"],["htmlFor","for"],["crossOrigin","crossorigin"],["httpEquiv","http-equiv"],["itemProp","itemprop"],["fetchPriority","fetchpriority"],["noModule","nomodule"],["formAction","formaction"]]),Ye=e=>tn.get(e)||e,dr=(e,t)=>{for(const[r,n]of Object.entries(e)){const s=r[0]==="-"||!/[A-Z]/.test(r)?r:r.replace(/[A-Z]/g,i=>`-${i.toLowerCase()}`);t(s,n==null?null:typeof n=="number"?s.match(/^(?:a|border-im|column(?:-c|s)|flex(?:$|-[^b])|grid-(?:ar|[^a])|font-w|li|or|sca|st|ta|wido|z)|ty$/)?`${n}`:`${n}px`:n)}},Re=void 0,xt=()=>Re,rn=e=>/[A-Z]/.test(e)&&e.match(/^(?:al|basel|clip(?:Path|Rule)$|co|do|fill|fl|fo|gl|let|lig|i|marker[EMS]|o|pai|pointe|sh|st[or]|text[^L]|tr|u|ve|w)/)?e.replace(/([A-Z])/g,"-$1").toLowerCase():e,nn=["area","base","br","col","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],sn=["allowfullscreen","async","autofocus","autoplay","checked","controls","default","defer","disabled","download","formnovalidate","hidden","inert","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected"],Ct=(e,t)=>{for(let r=0,n=e.length;r<n;r++){const s=e[r];if(typeof s=="string")te(s,t);else{if(typeof s=="boolean"||s===null||s===void 0)continue;s instanceof H?s.toStringToBuffer(t):typeof s=="number"||s.isEscaped?t[0]+=s:s instanceof Promise?t.unshift("",s):Ct(s,t)}}},H=class{constructor(e,t,r){v(this,"tag");v(this,"props");v(this,"key");v(this,"children");v(this,"isEscaped",!0);v(this,"localContexts");this.tag=e,this.props=t,this.children=r}get type(){return this.tag}get ref(){return this.props.ref||null}toString(){var t,r;const e=[""];(t=this.localContexts)==null||t.forEach(([n,s])=>{n.values.push(s)});try{this.toStringToBuffer(e)}finally{(r=this.localContexts)==null||r.forEach(([n])=>{n.values.pop()})}return e.length===1?"callbacks"in e?ir($(e[0],e.callbacks)).toString():e[0]:sr(e,e.callbacks)}toStringToBuffer(e){const t=this.tag,r=this.props;let{children:n}=this;e[0]+=`<${t}`;const s=Re&&Ce(Re)==="svg"?i=>rn(Ye(i)):i=>Ye(i);for(let[i,o]of Object.entries(r))if(i=s(i),i!=="children"){if(i==="style"&&typeof o=="object"){let a="";dr(o,(l,c)=>{c!=null&&(a+=`${a?";":""}${l}:${c}`)}),e[0]+=' style="',te(a,e),e[0]+='"'}else if(typeof o=="string")e[0]+=` ${i}="`,te(o,e),e[0]+='"';else if(o!=null)if(typeof o=="number"||o.isEscaped)e[0]+=` ${i}="${o}"`;else if(typeof o=="boolean"&&sn.includes(i))o&&(e[0]+=` ${i}=""`);else if(i==="dangerouslySetInnerHTML"){if(n.length>0)throw new Error("Can only set one of `children` or `props.dangerouslySetInnerHTML`.");n=[$(o.__html)]}else if(o instanceof Promise)e[0]+=` ${i}="`,e.unshift('"',o);else if(typeof o=="function"){if(!i.startsWith("on")&&i!=="ref")throw new Error(`Invalid prop '${i}' of type 'function' supplied to '${t}'.`)}else e[0]+=` ${i}="`,te(o.toString(),e),e[0]+='"'}if(nn.includes(t)&&n.length===0){e[0]+="/>";return}e[0]+=">",Ct(n,e),e[0]+=`</${t}>`}},ot=class extends H{toStringToBuffer(e){const{children:t}=this,r={...this.props};t.length&&(r.children=t.length===1?t[0]:t);const n=this.tag.call(null,r);if(!(typeof n=="boolean"||n==null))if(n instanceof Promise)if(be.length===0)e.unshift("",n);else{const s=be.map(i=>[i,i.values.at(-1)]);e.unshift("",n.then(i=>(i instanceof H&&(i.localContexts=s),i)))}else n instanceof H?n.toStringToBuffer(e):typeof n=="number"||n.isEscaped?(e[0]+=n,n.callbacks&&(e.callbacks||(e.callbacks=[]),e.callbacks.push(...n.callbacks))):te(n,e)}},hr=class extends H{toStringToBuffer(e){Ct(this.children,e)}},jt=(e,t,...r)=>{t??(t={}),r.length&&(t.children=r.length===1?r[0]:r);const n=t.key;delete t.key;const s=ze(e,t,r);return s.key=n,s},Pt=!1,ze=(e,t,r)=>{if(!Pt){for(const n in mt)it[n][wt]=mt[n];Pt=!0}return typeof e=="function"?new ot(e,t,r):it[e]?new ot(it[e],t,r):e==="svg"||e==="head"?(Re||(Re=bt("")),new H(e,t,[new ot(Re,{value:e},r)])):new H(e,t,r)},on=({children:e})=>new hr("",{children:e},Array.isArray(e)?e:e?[e]:[]);function p(e,t,r){let n;if(!t||!("children"in t))n=ze(e,t,[]);else{const s=t.children;n=Array.isArray(s)?ze(e,t,s):ze(e,t,[s])}return n.key=r,n}var kt=(e,t,r)=>(n,s)=>{let i=-1;return o(0);async function o(a){if(a<=i)throw new Error("next() called multiple times");i=a;let l,c=!1,f;if(e[a]?(f=e[a][0][0],n.req.routeIndex=a):f=a===e.length&&s||void 0,f)try{l=await f(n,()=>o(a+1))}catch(h){if(h instanceof Error&&t)n.error=h,l=await t(h,n),c=!0;else throw h}else n.finalized===!1&&r&&(l=await r(n));return l&&(n.finalized===!1||c)&&(n.res=l),n}},an=Symbol(),ln=async(e,t=Object.create(null))=>{const{all:r=!1,dot:n=!1}=t,i=(e instanceof Er?e.raw.headers:e.headers).get("Content-Type");return i!=null&&i.startsWith("multipart/form-data")||i!=null&&i.startsWith("application/x-www-form-urlencoded")?cn(e,{all:r,dot:n}):{}};async function cn(e,t){const r=await e.formData();return r?un(r,t):{}}function un(e,t){const r=Object.create(null);return e.forEach((n,s)=>{t.all||s.endsWith("[]")?fn(r,s,n):r[s]=n}),t.dot&&Object.entries(r).forEach(([n,s])=>{n.includes(".")&&(dn(r,n,s),delete r[n])}),r}var fn=(e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:t.endsWith("[]")?e[t]=[r]:e[t]=r},dn=(e,t,r)=>{let n=e;const s=t.split(".");s.forEach((i,o)=>{o===s.length-1?n[i]=r:((!n[i]||typeof n[i]!="object"||Array.isArray(n[i])||n[i]instanceof File)&&(n[i]=Object.create(null)),n=n[i])})},pr=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},hn=e=>{const{groups:t,path:r}=pn(e),n=pr(r);return mn(n,t)},pn=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(r,n)=>{const s=`@${n}`;return t.push([s,r]),s}),{groups:t,path:e}},mn=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[n]=t[r];for(let s=e.length-1;s>=0;s--)if(e[s].includes(n)){e[s]=e[s].replace(n,t[r][1]);break}}return e},We={},gn=(e,t)=>{if(e==="*")return"*";const r=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){const n=`${e}#${t}`;return We[n]||(r[2]?We[n]=t&&t[0]!==":"&&t[0]!=="*"?[n,r[1],new RegExp(`^${r[2]}(?=/${t})`)]:[e,r[1],new RegExp(`^${r[2]}$`)]:We[n]=[e,r[1],!0]),We[n]}return null},St=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},vn=e=>St(e,decodeURI),mr=e=>{const t=e.url,r=t.indexOf("/",t.indexOf(":")+4);let n=r;for(;n<t.length;n++){const s=t.charCodeAt(n);if(s===37){const i=t.indexOf("?",n),o=t.slice(r,i===-1?void 0:i);return vn(o.includes("%25")?o.replace(/%25/g,"%2525"):o)}else if(s===63)break}return t.slice(r,n)},yn=e=>{const t=mr(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},he=(e,t,...r)=>(r.length&&(t=he(t,...r)),`${(e==null?void 0:e[0])==="/"?"":"/"}${e}${t==="/"?"":`${(e==null?void 0:e.at(-1))==="/"?"":"/"}${(t==null?void 0:t[0])==="/"?t.slice(1):t}`}`),gr=e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;const t=e.split("/"),r=[];let n="";return t.forEach(s=>{if(s!==""&&!/\:/.test(s))n+="/"+s;else if(/\:/.test(s))if(/\?/.test(s)){r.length===0&&n===""?r.push("/"):r.push(n);const i=s.replace("?","");n+="/"+i,r.push(n)}else n+="/"+s}),r.filter((s,i,o)=>o.indexOf(s)===i)},at=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?St(e,yr):e):e,vr=(e,t,r)=>{let n;if(!r&&t&&!/[%+]/.test(t)){let o=e.indexOf("?",8);if(o===-1)return;for(e.startsWith(t,o+1)||(o=e.indexOf(`&${t}`,o+1));o!==-1;){const a=e.charCodeAt(o+t.length+1);if(a===61){const l=o+t.length+2,c=e.indexOf("&",l);return at(e.slice(l,c===-1?void 0:c))}else if(a==38||isNaN(a))return"";o=e.indexOf(`&${t}`,o+1)}if(n=/[%+]/.test(e),!n)return}const s={};n??(n=/[%+]/.test(e));let i=e.indexOf("?",8);for(;i!==-1;){const o=e.indexOf("&",i+1);let a=e.indexOf("=",i);a>o&&o!==-1&&(a=-1);let l=e.slice(i+1,a===-1?o===-1?void 0:o:a);if(n&&(l=at(l)),i=o,l==="")continue;let c;a===-1?c="":(c=e.slice(a+1,o===-1?void 0:o),n&&(c=at(c))),r?(s[l]&&Array.isArray(s[l])||(s[l]=[]),s[l].push(c)):s[l]??(s[l]=c)}return t?s[t]:s},En=vr,wn=(e,t)=>vr(e,t,!0),yr=decodeURIComponent,$t=e=>St(e,yr),ge,k,V,wr,br,gt,G,Jt,Er=(Jt=class{constructor(e,t="/",r=[[]]){x(this,V);v(this,"raw");x(this,ge);x(this,k);v(this,"routeIndex",0);v(this,"path");v(this,"bodyCache",{});x(this,G,e=>{const{bodyCache:t,raw:r}=this,n=t[e];if(n)return n;const s=Object.keys(t)[0];return s?t[s].then(i=>(s==="json"&&(i=JSON.stringify(i)),new Response(i)[e]())):t[e]=r[e]()});this.raw=e,this.path=t,w(this,k,r),w(this,ge,{})}param(e){return e?O(this,V,wr).call(this,e):O(this,V,br).call(this)}query(e){return En(this.url,e)}queries(e){return wn(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;const t={};return this.raw.headers.forEach((r,n)=>{t[n]=r}),t}async parseBody(e){var t;return(t=this.bodyCache).parsedBody??(t.parsedBody=await ln(this,e))}json(){return u(this,G).call(this,"text").then(e=>JSON.parse(e))}text(){return u(this,G).call(this,"text")}arrayBuffer(){return u(this,G).call(this,"arrayBuffer")}blob(){return u(this,G).call(this,"blob")}formData(){return u(this,G).call(this,"formData")}addValidatedData(e,t){u(this,ge)[e]=t}valid(e){return u(this,ge)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[an](){return u(this,k)}get matchedRoutes(){return u(this,k)[0].map(([[,e]])=>e)}get routePath(){return u(this,k)[0].map(([[,e]])=>e)[this.routeIndex].path}},ge=new WeakMap,k=new WeakMap,V=new WeakSet,wr=function(e){const t=u(this,k)[0][this.routeIndex][1][e],r=O(this,V,gt).call(this,t);return r&&/\%/.test(r)?$t(r):r},br=function(){const e={},t=Object.keys(u(this,k)[0][this.routeIndex][1]);for(const r of t){const n=O(this,V,gt).call(this,u(this,k)[0][this.routeIndex][1][r]);n!==void 0&&(e[r]=/\%/.test(n)?$t(n):n)}return e},gt=function(e){return u(this,k)[1]?u(this,k)[1][e]:e},G=new WeakMap,Jt),bn="text/plain; charset=UTF-8",lt=(e,t)=>({"Content-Type":e,...t}),Le,je,q,ve,B,P,Pe,ye,Ee,ie,ke,$e,X,pe,Gt,xn=(Gt=class{constructor(e,t){x(this,X);x(this,Le);x(this,je);v(this,"env",{});x(this,q);v(this,"finalized",!1);v(this,"error");x(this,ve);x(this,B);x(this,P);x(this,Pe);x(this,ye);x(this,Ee);x(this,ie);x(this,ke);x(this,$e);v(this,"render",(...e)=>(u(this,ye)??w(this,ye,t=>this.html(t)),u(this,ye).call(this,...e)));v(this,"setLayout",e=>w(this,Pe,e));v(this,"getLayout",()=>u(this,Pe));v(this,"setRenderer",e=>{w(this,ye,e)});v(this,"header",(e,t,r)=>{this.finalized&&w(this,P,new Response(u(this,P).body,u(this,P)));const n=u(this,P)?u(this,P).headers:u(this,ie)??w(this,ie,new Headers);t===void 0?n.delete(e):r!=null&&r.append?n.append(e,t):n.set(e,t)});v(this,"status",e=>{w(this,ve,e)});v(this,"set",(e,t)=>{u(this,q)??w(this,q,new Map),u(this,q).set(e,t)});v(this,"get",e=>u(this,q)?u(this,q).get(e):void 0);v(this,"newResponse",(...e)=>O(this,X,pe).call(this,...e));v(this,"body",(e,t,r)=>O(this,X,pe).call(this,e,t,r));v(this,"text",(e,t,r)=>!u(this,ie)&&!u(this,ve)&&!t&&!r&&!this.finalized?new Response(e):O(this,X,pe).call(this,e,t,lt(bn,r)));v(this,"json",(e,t,r)=>O(this,X,pe).call(this,JSON.stringify(e),t,lt("application/json",r)));v(this,"html",(e,t,r)=>{const n=s=>O(this,X,pe).call(this,s,t,lt("text/html; charset=UTF-8",r));return typeof e=="object"?or(e,nr.Stringify,!1,{}).then(n):n(e)});v(this,"redirect",(e,t)=>{const r=String(e);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,t??302)});v(this,"notFound",()=>(u(this,Ee)??w(this,Ee,()=>new Response),u(this,Ee).call(this,this)));w(this,Le,e),t&&(w(this,B,t.executionCtx),this.env=t.env,w(this,Ee,t.notFoundHandler),w(this,$e,t.path),w(this,ke,t.matchResult))}get req(){return u(this,je)??w(this,je,new Er(u(this,Le),u(this,$e),u(this,ke))),u(this,je)}get event(){if(u(this,B)&&"respondWith"in u(this,B))return u(this,B);throw Error("This context has no FetchEvent")}get executionCtx(){if(u(this,B))return u(this,B);throw Error("This context has no ExecutionContext")}get res(){return u(this,P)||w(this,P,new Response(null,{headers:u(this,ie)??w(this,ie,new Headers)}))}set res(e){if(u(this,P)&&e){e=new Response(e.body,e);for(const[t,r]of u(this,P).headers.entries())if(t!=="content-type")if(t==="set-cookie"){const n=u(this,P).headers.getSetCookie();e.headers.delete("set-cookie");for(const s of n)e.headers.append("set-cookie",s)}else e.headers.set(t,r)}w(this,P,e),this.finalized=!0}get var(){return u(this,q)?Object.fromEntries(u(this,q)):{}}},Le=new WeakMap,je=new WeakMap,q=new WeakMap,ve=new WeakMap,B=new WeakMap,P=new WeakMap,Pe=new WeakMap,ye=new WeakMap,Ee=new WeakMap,ie=new WeakMap,ke=new WeakMap,$e=new WeakMap,X=new WeakSet,pe=function(e,t,r){const n=u(this,P)?new Headers(u(this,P).headers):u(this,ie)??new Headers;if(typeof t=="object"&&"headers"in t){const i=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[o,a]of i)o.toLowerCase()==="set-cookie"?n.append(o,a):n.set(o,a)}if(r)for(const[i,o]of Object.entries(r))if(typeof o=="string")n.set(i,o);else{n.delete(i);for(const a of o)n.append(i,a)}const s=typeof t=="number"?t:(t==null?void 0:t.status)??u(this,ve);return new Response(e,{status:s,headers:n})},Gt),R="ALL",Cn="all",Sn=["get","post","put","delete","options","patch"],xr="Can not add a route since the matcher is already built.",Cr=class extends Error{},On="__COMPOSED_HANDLER",Nn=e=>e.text("404 Not Found",404),It=(e,t)=>{if("getResponse"in e){const r=e.getResponse();return t.newResponse(r.body,r)}return console.error(e),t.text("Internal Server Error",500)},M,_,Or,D,ne,Ke,Ve,Xt,Sr=(Xt=class{constructor(t={}){x(this,_);v(this,"get");v(this,"post");v(this,"put");v(this,"delete");v(this,"options");v(this,"patch");v(this,"all");v(this,"on");v(this,"use");v(this,"router");v(this,"getPath");v(this,"_basePath","/");x(this,M,"/");v(this,"routes",[]);x(this,D,Nn);v(this,"errorHandler",It);v(this,"onError",t=>(this.errorHandler=t,this));v(this,"notFound",t=>(w(this,D,t),this));v(this,"fetch",(t,...r)=>O(this,_,Ve).call(this,t,r[1],r[0],t.method));v(this,"request",(t,r,n,s)=>t instanceof Request?this.fetch(r?new Request(t,r):t,n,s):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${he("/",t)}`,r),n,s)));v(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(O(this,_,Ve).call(this,t.request,t,void 0,t.request.method))})});[...Sn,Cn].forEach(i=>{this[i]=(o,...a)=>(typeof o=="string"?w(this,M,o):O(this,_,ne).call(this,i,u(this,M),o),a.forEach(l=>{O(this,_,ne).call(this,i,u(this,M),l)}),this)}),this.on=(i,o,...a)=>{for(const l of[o].flat()){w(this,M,l);for(const c of[i].flat())a.map(f=>{O(this,_,ne).call(this,c.toUpperCase(),u(this,M),f)})}return this},this.use=(i,...o)=>(typeof i=="string"?w(this,M,i):(w(this,M,"*"),o.unshift(i)),o.forEach(a=>{O(this,_,ne).call(this,R,u(this,M),a)}),this);const{strict:n,...s}=t;Object.assign(this,s),this.getPath=n??!0?t.getPath??mr:yn}route(t,r){const n=this.basePath(t);return r.routes.map(s=>{var o;let i;r.errorHandler===It?i=s.handler:(i=async(a,l)=>(await kt([],r.errorHandler)(a,()=>s.handler(a,l))).res,i[On]=s.handler),O(o=n,_,ne).call(o,s.method,s.path,i)}),this}basePath(t){const r=O(this,_,Or).call(this);return r._basePath=he(this._basePath,t),r}mount(t,r,n){let s,i;n&&(typeof n=="function"?i=n:(i=n.optionHandler,n.replaceRequest===!1?s=l=>l:s=n.replaceRequest));const o=i?l=>{const c=i(l);return Array.isArray(c)?c:[c]}:l=>{let c;try{c=l.executionCtx}catch{}return[l.env,c]};s||(s=(()=>{const l=he(this._basePath,t),c=l==="/"?0:l.length;return f=>{const h=new URL(f.url);return h.pathname=h.pathname.slice(c)||"/",new Request(h,f)}})());const a=async(l,c)=>{const f=await r(s(l.req.raw),...o(l));if(f)return f;await c()};return O(this,_,ne).call(this,R,he(t,"*"),a),this}},M=new WeakMap,_=new WeakSet,Or=function(){const t=new Sr({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,w(t,D,u(this,D)),t.routes=this.routes,t},D=new WeakMap,ne=function(t,r,n){t=t.toUpperCase(),r=he(this._basePath,r);const s={basePath:this._basePath,path:r,method:t,handler:n};this.router.add(t,r,[n,s]),this.routes.push(s)},Ke=function(t,r){if(t instanceof Error)return this.errorHandler(t,r);throw t},Ve=function(t,r,n,s){if(s==="HEAD")return(async()=>new Response(null,await O(this,_,Ve).call(this,t,r,n,"GET")))();const i=this.getPath(t,{env:n}),o=this.router.match(s,i),a=new xn(t,{path:i,matchResult:o,env:n,executionCtx:r,notFoundHandler:u(this,D)});if(o[0].length===1){let c;try{c=o[0][0][0][0](a,async()=>{a.res=await u(this,D).call(this,a)})}catch(f){return O(this,_,Ke).call(this,f,a)}return c instanceof Promise?c.then(f=>f||(a.finalized?a.res:u(this,D).call(this,a))).catch(f=>O(this,_,Ke).call(this,f,a)):c??u(this,D).call(this,a)}const l=kt(o[0],this.errorHandler,u(this,D));return(async()=>{try{const c=await l(a);if(!c.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return c.res}catch(c){return O(this,_,Ke).call(this,c,a)}})()},Xt),Nr=[];function An(e,t){const r=this.buildAllMatchers(),n=(s,i)=>{const o=r[s]||r[R],a=o[2][i];if(a)return a;const l=i.match(o[0]);if(!l)return[[],Nr];const c=l.indexOf("",1);return[o[1][c],l]};return this.match=n,n(e,t)}var Qe="[^/]+",Ne=".*",Ae="(?:|/.*)",me=Symbol(),Rn=new Set(".\\+*[^]$()");function _n(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===Ne||e===Ae?1:t===Ne||t===Ae?-1:e===Qe?1:t===Qe?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var oe,ae,F,Zt,vt=(Zt=class{constructor(){x(this,oe);x(this,ae);x(this,F,Object.create(null))}insert(t,r,n,s,i){if(t.length===0){if(u(this,oe)!==void 0)throw me;if(i)return;w(this,oe,r);return}const[o,...a]=t,l=o==="*"?a.length===0?["","",Ne]:["","",Qe]:o==="/*"?["","",Ae]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let c;if(l){const f=l[1];let h=l[2]||Qe;if(f&&l[2]&&(h===".*"||(h=h.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(h))))throw me;if(c=u(this,F)[h],!c){if(Object.keys(u(this,F)).some(d=>d!==Ne&&d!==Ae))throw me;if(i)return;c=u(this,F)[h]=new vt,f!==""&&w(c,ae,s.varIndex++)}!i&&f!==""&&n.push([f,u(c,ae)])}else if(c=u(this,F)[o],!c){if(Object.keys(u(this,F)).some(f=>f.length>1&&f!==Ne&&f!==Ae))throw me;if(i)return;c=u(this,F)[o]=new vt}c.insert(a,r,n,s,i)}buildRegExpStr(){const r=Object.keys(u(this,F)).sort(_n).map(n=>{const s=u(this,F)[n];return(typeof u(s,ae)=="number"?`(${n})@${u(s,ae)}`:Rn.has(n)?`\\${n}`:n)+s.buildRegExpStr()});return typeof u(this,oe)=="number"&&r.unshift(`#${u(this,oe)}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}},oe=new WeakMap,ae=new WeakMap,F=new WeakMap,Zt),et,Ie,Yt,Tn=(Yt=class{constructor(){x(this,et,{varIndex:0});x(this,Ie,new vt)}insert(e,t,r){const n=[],s=[];for(let o=0;;){let a=!1;if(e=e.replace(/\{[^}]+\}/g,l=>{const c=`@\\${o}`;return s[o]=[c,l],o++,a=!0,c}),!a)break}const i=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let o=s.length-1;o>=0;o--){const[a]=s[o];for(let l=i.length-1;l>=0;l--)if(i[l].indexOf(a)!==-1){i[l]=i[l].replace(a,s[o][1]);break}}return u(this,Ie).insert(i,t,n,u(this,et),r),n}buildRegExp(){let e=u(this,Ie).buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const r=[],n=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(s,i,o)=>i!==void 0?(r[++t]=Number(i),"$()"):(o!==void 0&&(n[Number(o)]=++t),"")),[new RegExp(`^${e}`),r,n]}},et=new WeakMap,Ie=new WeakMap,Yt),Ln=[/^$/,[],Object.create(null)],Je=Object.create(null);function Ar(e){return Je[e]??(Je[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`))}function jn(){Je=Object.create(null)}function Pn(e){var c;const t=new Tn,r=[];if(e.length===0)return Ln;const n=e.map(f=>[!/\*|\/:/.test(f[0]),...f]).sort(([f,h],[d,g])=>f?1:d?-1:h.length-g.length),s=Object.create(null);for(let f=0,h=-1,d=n.length;f<d;f++){const[g,E,m]=n[f];g?s[E]=[m.map(([b])=>[b,Object.create(null)]),Nr]:h++;let y;try{y=t.insert(E,h,g)}catch(b){throw b===me?new Cr(E):b}g||(r[h]=m.map(([b,C])=>{const N=Object.create(null);for(C-=1;C>=0;C--){const[S,L]=y[C];N[S]=L}return[b,N]}))}const[i,o,a]=t.buildRegExp();for(let f=0,h=r.length;f<h;f++)for(let d=0,g=r[f].length;d<g;d++){const E=(c=r[f][d])==null?void 0:c[1];if(!E)continue;const m=Object.keys(E);for(let y=0,b=m.length;y<b;y++)E[m[y]]=a[E[m[y]]]}const l=[];for(const f in o)l[f]=r[o[f]];return[i,l,s]}function fe(e,t){if(e){for(const r of Object.keys(e).sort((n,s)=>s.length-n.length))if(Ar(r).test(t))return[...e[r]]}}var Z,Y,tt,Rr,Qt,kn=(Qt=class{constructor(){x(this,tt);v(this,"name","RegExpRouter");x(this,Z);x(this,Y);v(this,"match",An);w(this,Z,{[R]:Object.create(null)}),w(this,Y,{[R]:Object.create(null)})}add(e,t,r){var a;const n=u(this,Z),s=u(this,Y);if(!n||!s)throw new Error(xr);n[e]||[n,s].forEach(l=>{l[e]=Object.create(null),Object.keys(l[R]).forEach(c=>{l[e][c]=[...l[R][c]]})}),t==="/*"&&(t="*");const i=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const l=Ar(t);e===R?Object.keys(n).forEach(c=>{var f;(f=n[c])[t]||(f[t]=fe(n[c],t)||fe(n[R],t)||[])}):(a=n[e])[t]||(a[t]=fe(n[e],t)||fe(n[R],t)||[]),Object.keys(n).forEach(c=>{(e===R||e===c)&&Object.keys(n[c]).forEach(f=>{l.test(f)&&n[c][f].push([r,i])})}),Object.keys(s).forEach(c=>{(e===R||e===c)&&Object.keys(s[c]).forEach(f=>l.test(f)&&s[c][f].push([r,i]))});return}const o=gr(t)||[t];for(let l=0,c=o.length;l<c;l++){const f=o[l];Object.keys(s).forEach(h=>{var d;(e===R||e===h)&&((d=s[h])[f]||(d[f]=[...fe(n[h],f)||fe(n[R],f)||[]]),s[h][f].push([r,i-c+l+1]))})}}buildAllMatchers(){const e=Object.create(null);return Object.keys(u(this,Y)).concat(Object.keys(u(this,Z))).forEach(t=>{e[t]||(e[t]=O(this,tt,Rr).call(this,t))}),w(this,Z,w(this,Y,void 0)),jn(),e}},Z=new WeakMap,Y=new WeakMap,tt=new WeakSet,Rr=function(e){const t=[];let r=e===R;return[u(this,Z),u(this,Y)].forEach(n=>{const s=n[e]?Object.keys(n[e]).map(i=>[i,n[e][i]]):[];s.length!==0?(r||(r=!0),t.push(...s)):e!==R&&t.push(...Object.keys(n[R]).map(i=>[i,n[R][i]]))}),r?Pn(t):null},Qt),Q,z,er,$n=(er=class{constructor(e){v(this,"name","SmartRouter");x(this,Q,[]);x(this,z,[]);w(this,Q,e.routers)}add(e,t,r){if(!u(this,z))throw new Error(xr);u(this,z).push([e,t,r])}match(e,t){if(!u(this,z))throw new Error("Fatal error");const r=u(this,Q),n=u(this,z),s=r.length;let i=0,o;for(;i<s;i++){const a=r[i];try{for(let l=0,c=n.length;l<c;l++)a.add(...n[l]);o=a.match(e,t)}catch(l){if(l instanceof Cr)continue;throw l}this.match=a.match.bind(a),w(this,Q,[a]),w(this,z,void 0);break}if(i===s)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,o}get activeRouter(){if(u(this,z)||u(this,Q).length!==1)throw new Error("No active router has been determined yet.");return u(this,Q)[0]}},Q=new WeakMap,z=new WeakMap,er),Se=Object.create(null),ee,j,le,we,T,K,se,tr,_r=(tr=class{constructor(e,t,r){x(this,K);x(this,ee);x(this,j);x(this,le);x(this,we,0);x(this,T,Se);if(w(this,j,r||Object.create(null)),w(this,ee,[]),e&&t){const n=Object.create(null);n[e]={handler:t,possibleKeys:[],score:0},w(this,ee,[n])}w(this,le,[])}insert(e,t,r){w(this,we,++Rt(this,we)._);let n=this;const s=hn(t),i=[];for(let o=0,a=s.length;o<a;o++){const l=s[o],c=s[o+1],f=gn(l,c),h=Array.isArray(f)?f[0]:l;if(h in u(n,j)){n=u(n,j)[h],f&&i.push(f[1]);continue}u(n,j)[h]=new _r,f&&(u(n,le).push(f),i.push(f[1])),n=u(n,j)[h]}return u(n,ee).push({[e]:{handler:r,possibleKeys:i.filter((o,a,l)=>l.indexOf(o)===a),score:u(this,we)}}),n}search(e,t){var a;const r=[];w(this,T,Se);let s=[this];const i=pr(t),o=[];for(let l=0,c=i.length;l<c;l++){const f=i[l],h=l===c-1,d=[];for(let g=0,E=s.length;g<E;g++){const m=s[g],y=u(m,j)[f];y&&(w(y,T,u(m,T)),h?(u(y,j)["*"]&&r.push(...O(this,K,se).call(this,u(y,j)["*"],e,u(m,T))),r.push(...O(this,K,se).call(this,y,e,u(m,T)))):d.push(y));for(let b=0,C=u(m,le).length;b<C;b++){const N=u(m,le)[b],S=u(m,T)===Se?{}:{...u(m,T)};if(N==="*"){const J=u(m,j)["*"];J&&(r.push(...O(this,K,se).call(this,J,e,u(m,T))),w(J,T,S),d.push(J));continue}const[L,ue,re]=N;if(!f&&!(re instanceof RegExp))continue;const W=u(m,j)[L],Wr=i.slice(l).join("/");if(re instanceof RegExp){const J=re.exec(Wr);if(J){if(S[ue]=J[0],r.push(...O(this,K,se).call(this,W,e,u(m,T),S)),Object.keys(u(W,j)).length){w(W,T,S);const nt=((a=J[0].match(/\//))==null?void 0:a.length)??0;(o[nt]||(o[nt]=[])).push(W)}continue}}(re===!0||re.test(f))&&(S[ue]=f,h?(r.push(...O(this,K,se).call(this,W,e,S,u(m,T))),u(W,j)["*"]&&r.push(...O(this,K,se).call(this,u(W,j)["*"],e,S,u(m,T)))):(w(W,T,S),d.push(W)))}}s=d.concat(o.shift()??[])}return r.length>1&&r.sort((l,c)=>l.score-c.score),[r.map(({handler:l,params:c})=>[l,c])]}},ee=new WeakMap,j=new WeakMap,le=new WeakMap,we=new WeakMap,T=new WeakMap,K=new WeakSet,se=function(e,t,r,n){const s=[];for(let i=0,o=u(e,ee).length;i<o;i++){const a=u(e,ee)[i],l=a[t]||a[R],c={};if(l!==void 0&&(l.params=Object.create(null),s.push(l),r!==Se||n&&n!==Se))for(let f=0,h=l.possibleKeys.length;f<h;f++){const d=l.possibleKeys[f],g=c[l.score];l.params[d]=n!=null&&n[d]&&!g?n[d]:r[d]??(n==null?void 0:n[d]),c[l.score]=!0}}return s},tr),ce,rr,In=(rr=class{constructor(){v(this,"name","TrieRouter");x(this,ce);w(this,ce,new _r)}add(e,t,r){const n=gr(t);if(n){for(let s=0,i=n.length;s<i;s++)u(this,ce).insert(e,n[s],r);return}u(this,ce).insert(e,t,r)}match(e,t){return u(this,ce).search(e,t)}},ce=new WeakMap,rr),Tr=class extends Sr{constructor(e={}){super(e),this.router=e.router??new $n({routers:[new kn,new In]})}},Mn=e=>{const r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},n=(i=>typeof i=="string"?i==="*"?()=>i:o=>i===o?o:null:typeof i=="function"?i:o=>i.includes(o)?o:null)(r.origin),s=(i=>typeof i=="function"?i:Array.isArray(i)?()=>i:()=>[])(r.allowMethods);return async function(o,a){var f;function l(h,d){o.res.headers.set(h,d)}const c=await n(o.req.header("origin")||"",o);if(c&&l("Access-Control-Allow-Origin",c),r.credentials&&l("Access-Control-Allow-Credentials","true"),(f=r.exposeHeaders)!=null&&f.length&&l("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),o.req.method==="OPTIONS"){r.origin!=="*"&&l("Vary","Origin"),r.maxAge!=null&&l("Access-Control-Max-Age",r.maxAge.toString());const h=await s(o.req.header("origin")||"",o);h.length&&l("Access-Control-Allow-Methods",h.join(","));let d=r.allowHeaders;if(!(d!=null&&d.length)){const g=o.req.header("Access-Control-Request-Headers");g&&(d=g.split(/\s*,\s*/))}return d!=null&&d.length&&(l("Access-Control-Allow-Headers",d.join(",")),o.res.headers.append("Vary","Access-Control-Request-Headers")),o.res.headers.delete("Content-Length"),o.res.headers.delete("Content-Type"),new Response(null,{headers:o.res.headers,status:204,statusText:"No Content"})}await a(),r.origin!=="*"&&o.header("Vary","Origin",{append:!0})}},Dn=/^\s*(?:text\/(?!event-stream(?:[;\s]|$))[^;\s]+|application\/(?:javascript|json|xml|xml-dtd|ecmascript|dart|postscript|rtf|tar|toml|vnd\.dart|vnd\.ms-fontobject|vnd\.ms-opentype|wasm|x-httpd-php|x-javascript|x-ns-proxy-autoconfig|x-sh|x-tar|x-virtualbox-hdd|x-virtualbox-ova|x-virtualbox-ovf|x-virtualbox-vbox|x-virtualbox-vdi|x-virtualbox-vhd|x-virtualbox-vmdk|x-www-form-urlencoded)|font\/(?:otf|ttf)|image\/(?:bmp|vnd\.adobe\.photoshop|vnd\.microsoft\.icon|vnd\.ms-dds|x-icon|x-ms-bmp)|message\/rfc822|model\/gltf-binary|x-shader\/x-fragment|x-shader\/x-vertex|[^;\s]+?\+(?:json|text|xml|yaml))(?:[;\s]|$)/i,Mt=(e,t=Hn)=>{const r=/\.([a-zA-Z0-9]+?)$/,n=e.match(r);if(!n)return;let s=t[n[1]];return s&&s.startsWith("text")&&(s+="; charset=utf-8"),s},Fn={aac:"audio/aac",avi:"video/x-msvideo",avif:"image/avif",av1:"video/av1",bin:"application/octet-stream",bmp:"image/bmp",css:"text/css",csv:"text/csv",eot:"application/vnd.ms-fontobject",epub:"application/epub+zip",gif:"image/gif",gz:"application/gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",jsonld:"application/ld+json",map:"application/json",mid:"audio/x-midi",midi:"audio/x-midi",mjs:"text/javascript",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",oga:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",opus:"audio/opus",otf:"font/otf",pdf:"application/pdf",png:"image/png",rtf:"application/rtf",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",ts:"video/mp2t",ttf:"font/ttf",txt:"text/plain",wasm:"application/wasm",webm:"video/webm",weba:"audio/webm",webmanifest:"application/manifest+json",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xml:"application/xml",zip:"application/zip","3gp":"video/3gpp","3g2":"video/3gpp2",gltf:"model/gltf+json",glb:"model/gltf-binary"},Hn=Fn,Wn=(...e)=>{let t=e.filter(s=>s!=="").join("/");t=t.replace(new RegExp("(?<=\\/)\\/+","g"),"");const r=t.split("/"),n=[];for(const s of r)s===".."&&n.length>0&&n.at(-1)!==".."?n.pop():s!=="."&&n.push(s);return n.join("/")||"."},Lr={br:".br",zstd:".zst",gzip:".gz"},Un=Object.keys(Lr),qn="index.html",Bn=e=>{const t=e.root??"./",r=e.path,n=e.join??Wn;return async(s,i)=>{var f,h,d,g;if(s.finalized)return i();let o;if(e.path)o=e.path;else try{if(o=decodeURIComponent(s.req.path),/(?:^|[\/\\])\.\.(?:$|[\/\\])/.test(o))throw new Error}catch{return await((f=e.onNotFound)==null?void 0:f.call(e,s.req.path,s)),i()}let a=n(t,!r&&e.rewriteRequestPath?e.rewriteRequestPath(o):o);e.isDir&&await e.isDir(a)&&(a=n(a,qn));const l=e.getContent;let c=await l(a,s);if(c instanceof Response)return s.newResponse(c.body,c);if(c){const E=e.mimes&&Mt(a,e.mimes)||Mt(a);if(s.header("Content-Type",E||"application/octet-stream"),e.precompressed&&(!E||Dn.test(E))){const m=new Set((h=s.req.header("Accept-Encoding"))==null?void 0:h.split(",").map(y=>y.trim()));for(const y of Un){if(!m.has(y))continue;const b=await l(a+Lr[y],s);if(b){c=b,s.header("Content-Encoding",y),s.header("Vary","Accept-Encoding",{append:!0});break}}}return await((d=e.onFound)==null?void 0:d.call(e,a,s)),s.body(c)}await((g=e.onNotFound)==null?void 0:g.call(e,a,s)),await i()}},zn=async(e,t)=>{let r;t&&t.manifest?typeof t.manifest=="string"?r=JSON.parse(t.manifest):r=t.manifest:typeof __STATIC_CONTENT_MANIFEST=="string"?r=JSON.parse(__STATIC_CONTENT_MANIFEST):r=__STATIC_CONTENT_MANIFEST;let n;t&&t.namespace?n=t.namespace:n=__STATIC_CONTENT;const s=r[e]||e;if(!s)return null;const i=await n.get(s,{type:"stream"});return i||null},Kn=e=>async function(r,n){return Bn({...e,getContent:async i=>zn(i,{manifest:e.manifest,namespace:e.namespace?e.namespace:r.env?r.env.__STATIC_CONTENT:void 0})})(r,n)},Vn=e=>Kn(e),_e="_hp",Jn={Change:"Input",DoubleClick:"DblClick"},Gn={svg:"2000/svg",math:"1998/Math/MathML"},Te=[],yt=new WeakMap,xe=void 0,Xn=()=>xe,U=e=>"t"in e,ct={onClick:["click",!1]},Dt=e=>{if(!e.startsWith("on"))return;if(ct[e])return ct[e];const t=e.match(/^on([A-Z][a-zA-Z]+?(?:PointerCapture)?)(Capture)?$/);if(t){const[,r,n]=t;return ct[e]=[(Jn[r]||r).toLowerCase(),!!n]}},Ft=(e,t)=>xe&&e instanceof SVGElement&&/[A-Z]/.test(t)&&(t in e.style||t.match(/^(?:o|pai|str|u|ve)/))?t.replace(/([A-Z])/g,"-$1").toLowerCase():t,Zn=(e,t,r)=>{var n;t||(t={});for(let s in t){const i=t[s];if(s!=="children"&&(!r||r[s]!==i)){s=Ye(s);const o=Dt(s);if(o){if((r==null?void 0:r[s])!==i&&(r&&e.removeEventListener(o[0],r[s],o[1]),i!=null)){if(typeof i!="function")throw new Error(`Event handler for "${s}" is not a function`);e.addEventListener(o[0],i,o[1])}}else if(s==="dangerouslySetInnerHTML"&&i)e.innerHTML=i.__html;else if(s==="ref"){let a;typeof i=="function"?a=i(e)||(()=>i(null)):i&&"current"in i&&(i.current=e,a=()=>i.current=null),yt.set(e,a)}else if(s==="style"){const a=e.style;typeof i=="string"?a.cssText=i:(a.cssText="",i!=null&&dr(i,a.setProperty.bind(a)))}else{if(s==="value"){const l=e.nodeName;if(l==="INPUT"||l==="TEXTAREA"||l==="SELECT"){if(e.value=i==null||i===!1?null:i,l==="TEXTAREA"){e.textContent=i;continue}else if(l==="SELECT"){e.selectedIndex===-1&&(e.selectedIndex=0);continue}}}else(s==="checked"&&e.nodeName==="INPUT"||s==="selected"&&e.nodeName==="OPTION")&&(e[s]=i);const a=Ft(e,s);i==null||i===!1?e.removeAttribute(a):i===!0?e.setAttribute(a,""):typeof i=="string"||typeof i=="number"?e.setAttribute(a,i):e.setAttribute(a,i.toString())}}}if(r)for(let s in r){const i=r[s];if(s!=="children"&&!(s in t)){s=Ye(s);const o=Dt(s);o?e.removeEventListener(o[0],i,o[1]):s==="ref"?(n=yt.get(e))==null||n():e.removeAttribute(Ft(e,s))}}},Yn=(e,t)=>{t[A][0]=0,Te.push([e,t]);const r=t.tag[wt]||t.tag,n=r.defaultProps?{...r.defaultProps,...t.props}:t.props;try{return[r.call(null,n)]}finally{Te.pop()}},jr=(e,t,r,n,s)=>{var i,o;(i=e.vR)!=null&&i.length&&(n.push(...e.vR),delete e.vR),typeof e.tag=="function"&&((o=e[A][1][Ir])==null||o.forEach(a=>s.push(a))),e.vC.forEach(a=>{var l;if(U(a))r.push(a);else if(typeof a.tag=="function"||a.tag===""){a.c=t;const c=r.length;if(jr(a,t,r,n,s),a.s){for(let f=c;f<r.length;f++)r[f].s=!0;a.s=!1}}else r.push(a),(l=a.vR)!=null&&l.length&&(n.push(...a.vR),delete a.vR)})},Qn=e=>{for(;;e=e.tag===_e||!e.vC||!e.pP?e.nN:e.vC[0]){if(!e)return null;if(e.tag!==_e&&e.e)return e.e}},Pr=e=>{var t,r,n,s,i,o;U(e)||((r=(t=e[A])==null?void 0:t[1][Ir])==null||r.forEach(a=>{var l;return(l=a[2])==null?void 0:l.call(a)}),(n=yt.get(e.e))==null||n(),e.p===2&&((s=e.vC)==null||s.forEach(a=>a.p=2)),(i=e.vC)==null||i.forEach(Pr)),e.p||((o=e.e)==null||o.remove(),delete e.e),typeof e.tag=="function"&&(Oe.delete(e),Ge.delete(e),delete e[A][3],e.a=!0)},kr=(e,t,r)=>{e.c=t,$r(e,t,r)},Ht=(e,t)=>{if(t){for(let r=0,n=e.length;r<n;r++)if(e[r]===t)return r}},Wt=Symbol(),$r=(e,t,r)=>{var c;const n=[],s=[],i=[];jr(e,t,n,s,i),s.forEach(Pr);const o=r?void 0:t.childNodes;let a,l=null;if(r)a=-1;else if(!o.length)a=0;else{const f=Ht(o,Qn(e.nN));f!==void 0?(l=o[f],a=f):a=Ht(o,(c=n.find(h=>h.tag!==_e&&h.e))==null?void 0:c.e)??-1,a===-1&&(r=!0)}for(let f=0,h=n.length;f<h;f++,a++){const d=n[f];let g;if(d.s&&d.e)g=d.e,d.s=!1;else{const E=r||!d.e;U(d)?(d.e&&d.d&&(d.e.textContent=d.t),d.d=!1,g=d.e||(d.e=document.createTextNode(d.t))):(g=d.e||(d.e=d.n?document.createElementNS(d.n,d.tag):document.createElement(d.tag)),Zn(g,d.props,d.pP),$r(d,g,E))}d.tag===_e?a--:r?g.parentNode||t.appendChild(g):o[a]!==g&&o[a-1]!==g&&(o[a+1]===g?t.appendChild(o[a]):t.insertBefore(g,l||o[a]||null))}if(e.pP&&delete e.pP,i.length){const f=[],h=[];i.forEach(([,d,,g,E])=>{d&&f.push(d),g&&h.push(g),E==null||E()}),f.forEach(d=>d()),h.length&&requestAnimationFrame(()=>{h.forEach(d=>d())})}},es=(e,t)=>!!(e&&e.length===t.length&&e.every((r,n)=>r[1]===t[n][1])),Ge=new WeakMap,Et=(e,t,r)=>{var i,o,a,l,c,f;const n=!r&&t.pC;r&&(t.pC||(t.pC=t.vC));let s;try{r||(r=typeof t.tag=="function"?Yn(e,t):Me(t.props.children)),((i=r[0])==null?void 0:i.tag)===""&&r[0][pt]&&(s=r[0][pt],e[5].push([e,s,t]));const h=n?[...t.pC]:t.vC?[...t.vC]:void 0,d=[];let g;for(let E=0;E<r.length;E++){Array.isArray(r[E])&&r.splice(E,1,...r[E].flat());let m=ts(r[E]);if(m){typeof m.tag=="function"&&!m.tag[ar]&&(be.length>0&&(m[A][2]=be.map(b=>[b,b.values.at(-1)])),(o=e[5])!=null&&o.length&&(m[A][3]=e[5].at(-1)));let y;if(h&&h.length){const b=h.findIndex(U(m)?C=>U(C):m.key!==void 0?C=>C.key===m.key&&C.tag===m.tag:C=>C.tag===m.tag);b!==-1&&(y=h[b],h.splice(b,1))}if(y)if(U(m))y.t!==m.t&&(y.t=m.t,y.d=!0),m=y;else{const b=y.pP=y.props;if(y.props=m.props,y.f||(y.f=m.f||t.f),typeof m.tag=="function"){const C=y[A][2];y[A][2]=m[A][2]||[],y[A][3]=m[A][3],!y.f&&((y.o||y)===m.o||(l=(a=y.tag)[Kr])!=null&&l.call(a,b,y.props))&&es(C,y[A][2])&&(y.s=!0)}m=y}else if(!U(m)&&xe){const b=Ce(xe);b&&(m.n=b)}if(!U(m)&&!m.s&&(Et(e,m),delete m.f),d.push(m),g&&!g.s&&!m.s)for(let b=g;b&&!U(b);b=(c=b.vC)==null?void 0:c.at(-1))b.nN=m;g=m}}t.vR=n?[...t.vC,...h||[]]:h||[],t.vC=d,n&&delete t.pC}catch(h){if(t.f=!0,h===Wt){if(s)return;throw h}const[d,g,E]=((f=t[A])==null?void 0:f[3])||[];if(g){const m=()=>Xe([0,!1,e[2]],E),y=Ge.get(E)||[];y.push(m),Ge.set(E,y);const b=g(h,()=>{const C=Ge.get(E);if(C){const N=C.indexOf(m);if(N!==-1)return C.splice(N,1),m()}});if(b){if(e[0]===1)e[1]=!0;else if(Et(e,E,[b]),(g.length===1||e!==d)&&E.c){kr(E,E.c,!1);return}throw Wt}}throw h}finally{s&&e[5].pop()}},ts=e=>{if(!(e==null||typeof e=="boolean")){if(typeof e=="string"||typeof e=="number")return{t:e.toString(),d:!0};if("vR"in e&&(e={tag:e.tag,props:e.props,key:e.key,f:e.f,type:e.tag,ref:e.props.ref,o:e.o||e}),typeof e.tag=="function")e[A]=[0,[]];else{const t=Gn[e.tag];t&&(xe||(xe=cr("")),e.props.children=[{tag:xe,props:{value:e.n=`http://www.w3.org/${t}`,children:e.props.children}}])}return e}},Ut=(e,t)=>{var r,n;(r=t[A][2])==null||r.forEach(([s,i])=>{s.values.push(i)});try{Et(e,t,void 0)}catch{return}if(t.a){delete t.a;return}(n=t[A][2])==null||n.forEach(([s])=>{s.values.pop()}),(e[0]!==1||!e[1])&&kr(t,t.c,!1)},Oe=new WeakMap,qt=[],Xe=async(e,t)=>{e[5]||(e[5]=[]);const r=Oe.get(t);r&&r[0](void 0);let n;const s=new Promise(i=>n=i);if(Oe.set(t,[n,()=>{e[2]?e[2](e,t,i=>{Ut(i,t)}).then(()=>n(t)):(Ut(e,t),n(t))}]),qt.length)qt.at(-1).add(t);else{await Promise.resolve();const i=Oe.get(t);i&&(Oe.delete(t),i[1]())}return s},rs=(e,t,r)=>({tag:_e,props:{children:e},key:r,e:t,p:1}),ut=0,Ir=1,ft=2,dt=3,ht=new WeakMap,Mr=(e,t)=>!e||!t||e.length!==t.length||t.some((r,n)=>r!==e[n]),ns=void 0,Bt=[],ss=e=>{var o;const t=()=>typeof e=="function"?e():e,r=Te.at(-1);if(!r)return[t(),()=>{}];const[,n]=r,s=(o=n[A][1])[ut]||(o[ut]=[]),i=n[A][0]++;return s[i]||(s[i]=[t(),a=>{const l=ns,c=s[i];if(typeof a=="function"&&(a=a(c[0])),!Object.is(a,c[0]))if(c[0]=a,Bt.length){const[f,h]=Bt.at(-1);Promise.all([f===3?n:Xe([f,!1,l],n),h]).then(([d])=>{if(!d||!(f===2||f===3))return;const g=d.vC;requestAnimationFrame(()=>{setTimeout(()=>{g===d.vC&&Xe([f===3?1:0,!1,l],d)})})})}else Xe([0,!1,l],n)}])},Ot=(e,t)=>{var a;const r=Te.at(-1);if(!r)return e;const[,n]=r,s=(a=n[A][1])[ft]||(a[ft]=[]),i=n[A][0]++,o=s[i];return Mr(o==null?void 0:o[1],t)?s[i]=[e,t]:e=s[i][0],e},is=e=>{const t=ht.get(e);if(t){if(t.length===2)throw t[1];return t[0]}throw e.then(r=>ht.set(e,[r]),r=>ht.set(e,[void 0,r])),e},os=(e,t)=>{var a;const r=Te.at(-1);if(!r)return e();const[,n]=r,s=(a=n[A][1])[dt]||(a[dt]=[]),i=n[A][0]++,o=s[i];return Mr(o==null?void 0:o[1],t)&&(s[i]=[e(),t]),s[i][0]},as=cr({pending:!1,data:null,method:null,action:null}),zt=new Set,ls=e=>{zt.add(e),e.finally(()=>zt.delete(e))},Nt=(e,t)=>os(()=>r=>{let n;e&&(typeof e=="function"?n=e(r)||(()=>{e(null)}):e&&"current"in e&&(e.current=r,n=()=>{e.current=null}));const s=t(r);return()=>{s==null||s(),n==null||n()}},[e]),de=Object.create(null),Ue=Object.create(null),He=(e,t,r,n,s)=>{if(t!=null&&t.itemProp)return{tag:e,props:t,type:e,ref:t.ref};const i=document.head;let{onLoad:o,onError:a,precedence:l,blocking:c,...f}=t,h=null,d=!1;const g=qe[e];let E;if(g.length>0){const C=i.querySelectorAll(e);e:for(const N of C)for(const S of qe[e])if(N.getAttribute(S)===t[S]){h=N;break e}if(!h){const N=g.reduce((S,L)=>t[L]===void 0?S:`${S}-${L}-${t[L]}`,e);d=!Ue[N],h=Ue[N]||(Ue[N]=(()=>{const S=document.createElement(e);for(const L of g)t[L]!==void 0&&S.setAttribute(L,t[L]),t.rel&&S.setAttribute("rel",t.rel);return S})())}}else E=i.querySelectorAll(e);l=n?l??"":void 0,n&&(f[Be]=l);const m=Ot(C=>{if(g.length>0){let N=!1;for(const S of i.querySelectorAll(e)){if(N&&S.getAttribute(Be)!==l){i.insertBefore(C,S);return}S.getAttribute(Be)===l&&(N=!0)}i.appendChild(C)}else if(E){let N=!1;for(const S of E)if(S===C){N=!0;break}N||i.insertBefore(C,i.contains(E[0])?E[0]:i.querySelector(e)),E=void 0}},[l]),y=Nt(t.ref,C=>{var L;const N=g[0];if(r===2&&(C.innerHTML=""),(d||E)&&m(C),!a&&!o)return;let S=de[L=C.getAttribute(N)]||(de[L]=new Promise((ue,re)=>{C.addEventListener("load",ue),C.addEventListener("error",re)}));o&&(S=S.then(o)),a&&(S=S.catch(a)),S.catch(()=>{})});if(s&&c==="render"){const C=qe[e][0];if(t[C]){const N=t[C],S=de[N]||(de[N]=new Promise((L,ue)=>{m(h),h.addEventListener("load",L),h.addEventListener("error",ue)}));is(S)}}const b={tag:e,type:e,props:{...f,ref:y},ref:y};return b.p=r,h&&(b.e=h),rs(b,i)},cs=e=>{const t=Xn(),r=t&&Ce(t);return r!=null&&r.endsWith("svg")?{tag:"title",props:e,type:"title",ref:e.ref}:He("title",e,void 0,!1,!1)},us=e=>!e||["src","async"].some(t=>!e[t])?{tag:"script",props:e,type:"script",ref:e.ref}:He("script",e,1,!1,!0),fs=e=>!e||!["href","precedence"].every(t=>t in e)?{tag:"style",props:e,type:"style",ref:e.ref}:(e["data-href"]=e.href,delete e.href,He("style",e,2,!0,!0)),ds=e=>!e||["onLoad","onError"].some(t=>t in e)||e.rel==="stylesheet"&&(!("precedence"in e)||"disabled"in e)?{tag:"link",props:e,type:"link",ref:e.ref}:He("link",e,1,"precedence"in e,!0),hs=e=>He("meta",e,void 0,!1,!1),Dr=Symbol(),ps=e=>{const{action:t,...r}=e;typeof t!="function"&&(r.action=t);const[n,s]=ss([null,!1]),i=Ot(async c=>{const f=c.isTrusted?t:c.detail[Dr];if(typeof f!="function")return;c.preventDefault();const h=new FormData(c.target);s([h,!0]);const d=f(h);d instanceof Promise&&(ls(d),await d),s([null,!0])},[]),o=Nt(e.ref,c=>(c.addEventListener("submit",i),()=>{c.removeEventListener("submit",i)})),[a,l]=n;return n[1]=!1,{tag:as,props:{value:{pending:a!==null,data:a,method:a?"post":null,action:a?t:null},children:{tag:"form",props:{...r,ref:o},type:"form",ref:o}},f:l}},Fr=(e,{formAction:t,...r})=>{if(typeof t=="function"){const n=Ot(s=>{s.preventDefault(),s.currentTarget.form.dispatchEvent(new CustomEvent("submit",{detail:{[Dr]:t}}))},[]);r.ref=Nt(r.ref,s=>(s.addEventListener("click",n),()=>{s.removeEventListener("click",n)}))}return{tag:e,props:r,type:e,ref:r.ref}},ms=e=>Fr("input",e),gs=e=>Fr("button",e);Object.assign(mt,{title:cs,script:us,style:fs,link:ds,meta:hs,form:ps,input:ms,button:gs});bt(null);new TextEncoder;var vs=bt(null),ys=(e,t,r,n)=>(s,i)=>{const o="<!DOCTYPE html>",a=r?jt(c=>r(c,e),{Layout:t,...i},s):s,l=zr`${$(o)}${jt(vs.Provider,{value:e},a)}`;return e.html(l)},Es=(e,t)=>function(n,s){const i=n.getLayout()??on;return e&&n.setLayout(o=>e({...o,Layout:i},n)),n.setRenderer(ys(n,i,e)),s()};const ws=Es(({children:e})=>p("html",{lang:"ja",children:[p("head",{children:[p("meta",{charset:"UTF-8"}),p("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),p("title",{children:"ダンススクール チケット管理"}),p("script",{src:"https://cdn.tailwindcss.com"}),p("link",{href:"/static/style.css",rel:"stylesheet"})]}),p("body",{children:e})]})),I=new Tr;I.use("/static/*",Vn({root:"./"}));I.use("/api/*",Mn());I.use(ws);function rt(){const e=new Date;return new Date(e.getTime()+540*60*1e3).toISOString().slice(0,19).replace("T"," ")}async function bs(e,t,r,n,s){if(!e){console.log("LINE_CHANNEL_ACCESS_TOKEN is not set. Skipping LINE notification.");return}if(!t){console.log(`LINE User ID not set for customer: ${r}. Skipping LINE notification.`);return}const i=n>0?`【チケット追加】
${r}様
チケットを${n}枚追加しました。
残り: ${s}枚`:`【チケット使用】
${r}様
チケットを${Math.abs(n)}枚使用しました。
残り: ${s}枚`;try{const o=await fetch("https://api.line.me/v2/bot/message/push",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({to:t,messages:[{type:"text",text:i}]})});if(o.ok)console.log(`LINE notification sent to ${r} (${t})`);else{const a=await o.text();console.error("LINE notification failed:",a)}}catch(o){console.error("LINE notification error:",o)}}I.get("/api/customers",async e=>{try{const{results:t}=await e.env.DB.prepare("SELECT * FROM customers ORDER BY name ASC").all();return e.json({customers:t})}catch{return e.json({error:"Failed to fetch customers"},500)}});I.get("/api/customers/:id",async e=>{const t=e.req.param("id");try{const r=await e.env.DB.prepare("SELECT * FROM customers WHERE id = ?").bind(t).first();if(!r)return e.json({error:"Customer not found"},404);const{results:n}=await e.env.DB.prepare("SELECT * FROM ticket_history WHERE customer_id = ? ORDER BY created_at DESC").bind(t).all();return e.json({customer:r,history:n})}catch{return e.json({error:"Failed to fetch customer"},500)}});I.post("/api/customers",async e=>{try{const{name:t,phone:r,email:n,ticket_count:s,line_user_id:i}=await e.req.json();if(!t)return e.json({error:"Name is required"},400);const o=rt(),l=(await e.env.DB.prepare("INSERT INTO customers (name, phone, email, ticket_count, line_user_id, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?)").bind(t,r||null,n||null,s||0,i||null,o,o).run()).meta.last_row_id;return s&&s>0&&await e.env.DB.prepare("INSERT INTO ticket_history (customer_id, change_amount, previous_count, new_count, note, created_at) VALUES (?, ?, ?, ?, ?, ?)").bind(l,s,0,s,"初回登録",o).run(),e.json({id:l,name:t,phone:r,email:n,ticket_count:s||0,line_user_id:i||null})}catch{return e.json({error:"Failed to create customer"},500)}});I.post("/api/customers/:id/tickets",async e=>{const t=e.req.param("id");try{const{change_amount:r,note:n}=await e.req.json();if(r===void 0||r===0)return e.json({error:"change_amount is required and must not be zero"},400);const s=await e.env.DB.prepare("SELECT * FROM customers WHERE id = ?").bind(t).first();if(!s)return e.json({error:"Customer not found"},404);const i=s.ticket_count,o=i+r;if(o<0)return e.json({error:"Insufficient tickets"},400);const a=rt();return await e.env.DB.prepare("UPDATE customers SET ticket_count = ?, updated_at = ? WHERE id = ?").bind(o,a,t).run(),await e.env.DB.prepare("INSERT INTO ticket_history (customer_id, change_amount, previous_count, new_count, note, created_at) VALUES (?, ?, ?, ?, ?, ?)").bind(t,r,i,o,n||null,a).run(),await bs(e.env.LINE_CHANNEL_ACCESS_TOKEN,s.line_user_id,s.name,r,o),e.json({customer_id:t,previous_count:i,change_amount:r,new_count:o})}catch(r){return console.error("Ticket update error:",r),e.json({error:"Failed to update tickets"},500)}});I.delete("/api/customers/:id",async e=>{const t=e.req.param("id");try{return await e.env.DB.prepare("DELETE FROM customers WHERE id = ?").bind(t).run(),e.json({success:!0})}catch{return e.json({error:"Failed to delete customer"},500)}});I.put("/api/customers/:id",async e=>{const t=e.req.param("id");try{const{name:r,phone:n,email:s,line_user_id:i}=await e.req.json();if(!r)return e.json({error:"Name is required"},400);if(!await e.env.DB.prepare("SELECT * FROM customers WHERE id = ?").bind(t).first())return e.json({error:"Customer not found"},404);const a=rt();return await e.env.DB.prepare("UPDATE customers SET name = ?, phone = ?, email = ?, line_user_id = ?, updated_at = ? WHERE id = ?").bind(r,n||null,s||null,i||null,a,t).run(),e.json({id:t,name:r,phone:n,email:s,line_user_id:i})}catch(r){return console.error("Customer update error:",r),e.json({error:"Failed to update customer"},500)}});I.post("/api/line/webhook",async e=>{try{const t=await e.req.json();console.log("========================================"),console.log("LINE Webhook received:",JSON.stringify(t,null,2)),console.log("========================================");const r=t.events||[];console.log(`Number of events: ${r.length}`);for(const n of r){if(console.log(`Processing event type: ${n.type}`),n.type==="follow"){const s=n.source.userId;console.log(`[FOLLOW] User ID: ${s}`),console.log(`[FOLLOW] ACCESS_TOKEN exists: ${!!e.env.LINE_CHANNEL_ACCESS_TOKEN}`);const i=await xs(e.env.LINE_CHANNEL_ACCESS_TOKEN,s);if(console.log(`[FOLLOW] Profile retrieved: ${!!i}`),i){console.log(`[FOLLOW] Display name: ${i.displayName}`);const o=await e.env.DB.prepare("SELECT * FROM customers WHERE line_user_id = ?").bind(s).first();if(console.log(`[FOLLOW] Existing customer: ${!!o}`),o)console.log(`[FOLLOW] Customer already exists: ${s}`),await Kt(e.env.LINE_CHANNEL_ACCESS_TOKEN,s,i.displayName,!0);else{console.log("[FOLLOW] Creating new customer...");const a=rt();console.log(`[FOLLOW] JST timestamp: ${a}`);const l=await e.env.DB.prepare("INSERT INTO customers (name, phone, email, ticket_count, line_user_id, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?)").bind(i.displayName,null,null,0,s,a,a).run();console.log("[FOLLOW] DB insert result:",JSON.stringify(l.meta)),console.log(`[FOLLOW] New customer created with ID: ${l.meta.last_row_id}`),await Kt(e.env.LINE_CHANNEL_ACCESS_TOKEN,s,i.displayName,!1),console.log("[FOLLOW] Welcome message sent")}}else console.error(`[FOLLOW] Failed to get profile for user: ${s}`)}if(n.type==="unfollow"){const s=n.source.userId;console.log(`[UNFOLLOW] User ID: ${s}`)}}return console.log("========================================"),console.log("Webhook processing completed successfully"),console.log("========================================"),e.json({success:!0})}catch(t){return console.error("========================================"),console.error("LINE Webhook error:",t),console.error("Error details:",JSON.stringify(t,Object.getOwnPropertyNames(t))),console.error("========================================"),e.json({error:"Webhook processing failed"},500)}});async function xs(e,t){if(console.log(`[getLineUserProfile] Called for user: ${t}`),console.log(`[getLineUserProfile] Access token present: ${!!e}`),!e)return console.error("[getLineUserProfile] LINE_CHANNEL_ACCESS_TOKEN is not set"),null;try{const r=`https://api.line.me/v2/bot/profile/${t}`;console.log(`[getLineUserProfile] Fetching: ${r}`);const n=await fetch(r,{headers:{Authorization:`Bearer ${e}`}});if(console.log(`[getLineUserProfile] Response status: ${n.status}`),!n.ok){const i=await n.text();return console.error("[getLineUserProfile] Failed to get LINE profile:",i),null}const s=await n.json();return console.log("[getLineUserProfile] Profile retrieved:",JSON.stringify(s)),s}catch(r){return console.error("[getLineUserProfile] Error:",r),console.error("[getLineUserProfile] Error details:",JSON.stringify(r,Object.getOwnPropertyNames(r))),null}}async function Kt(e,t,r,n){if(console.log(`[sendWelcomeMessage] Called for user: ${t}, displayName: ${r}, isExisting: ${n}`),!e){console.error("[sendWelcomeMessage] LINE_CHANNEL_ACCESS_TOKEN is not set. Skipping welcome message.");return}const s=n?`${r}様

お帰りなさい！
再度友達追加ありがとうございます。

チケットの残数確認や各種お知らせは、こちらのアカウントからお送りします。`:`${r}様

ダンススクールの公式LINEへようこそ！
友達追加ありがとうございます🎉

こちらのアカウントでは、チケットの購入・利用状況をお知らせします。

何かご不明な点がございましたら、お気軽にお問い合わせください。`;console.log(`[sendWelcomeMessage] Message length: ${s.length}`);try{const i=await fetch("https://api.line.me/v2/bot/message/push",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({to:t,messages:[{type:"text",text:s}]})});if(console.log(`[sendWelcomeMessage] Response status: ${i.status}`),i.ok)console.log(`[sendWelcomeMessage] Success! Message sent to ${t}`);else{const o=await i.text();console.error("[sendWelcomeMessage] Failed:",o)}}catch(i){console.error("[sendWelcomeMessage] Error:",i),console.error("[sendWelcomeMessage] Error details:",JSON.stringify(i,Object.getOwnPropertyNames(i)))}}I.get("/",e=>e.render(p("div",{class:"container",children:[p("div",{id:"customerListScreen",class:"screen active",children:p("div",{class:"section full-width",children:[p("div",{class:"section-header",children:[p("h2",{children:"🎫 顧客一覧"}),p("button",{onclick:"showAddCustomerModal()",class:"btn btn-primary",children:"➕ 新規顧客登録"})]}),p("div",{id:"customerList",children:p("p",{class:"loading",children:"読み込み中..."})})]})}),p("div",{id:"customerDetailScreen",class:"screen",children:p("div",{class:"section full-width",children:[p("div",{class:"section-header",children:[p("button",{onclick:"backToCustomerList()",class:"btn btn-secondary",children:"← 一覧に戻る"}),p("h2",{children:"👤 顧客詳細"}),p("div",{})]}),p("div",{id:"customerDetail"})]})}),p("div",{id:"addCustomerModal",class:"modal",children:p("div",{class:"modal-content",children:[p("div",{class:"modal-header",children:[p("h3",{children:"新規顧客登録"}),p("button",{onclick:"closeAddCustomerModal()",class:"btn btn-text",children:"✕"})]}),p("form",{id:"addCustomerForm",children:[p("div",{class:"form-group",children:[p("label",{children:"氏名 *"}),p("input",{type:"text",name:"name",required:!0})]}),p("div",{class:"form-group",children:[p("label",{children:"電話番号"}),p("input",{type:"tel",name:"phone"})]}),p("div",{class:"form-group",children:[p("label",{children:"メールアドレス"}),p("input",{type:"email",name:"email"})]}),p("div",{class:"form-group",children:[p("label",{children:"初期チケット枚数"}),p("input",{type:"number",name:"ticket_count",min:"0",value:"0"})]}),p("div",{class:"form-group",children:[p("label",{children:"LINE User ID（任意）"}),p("input",{type:"text",name:"line_user_id",placeholder:"U1234567890abcdef..."}),p("small",{style:"color: #6b7280; font-size: 12px; display: block; margin-top: 4px;",children:"LINEで通知を受け取る場合は、User IDを入力してください"})]}),p("div",{class:"form-actions",children:[p("button",{type:"button",onclick:"closeAddCustomerModal()",class:"btn btn-secondary",children:"キャンセル"}),p("button",{type:"submit",class:"btn btn-primary",children:"登録"})]})]})]})}),p("div",{id:"ticketModal",class:"modal",children:p("div",{class:"modal-content",children:[p("div",{class:"modal-header",children:[p("h3",{children:"チケット増減"}),p("button",{onclick:"closeTicketModal()",class:"btn btn-text",children:"✕"})]}),p("form",{id:"ticketForm",children:[p("input",{type:"hidden",id:"ticketCustomerId"}),p("div",{class:"form-group",children:[p("label",{children:"変更枚数"}),p("input",{type:"number",id:"ticketChangeAmount",name:"change_amount",required:!0,placeholder:"正の数で追加、負の数で減少"})]}),p("div",{class:"form-group",children:[p("label",{children:"メモ"}),p("textarea",{name:"note",rows:"3",placeholder:"例: 10回チケット購入"})]}),p("div",{class:"form-actions",children:[p("button",{type:"button",onclick:"closeTicketModal()",class:"btn btn-secondary",children:"キャンセル"}),p("button",{type:"submit",class:"btn btn-primary",children:"更新"})]})]})]})}),p("div",{id:"editCustomerModal",class:"modal",children:p("div",{class:"modal-content",children:[p("div",{class:"modal-header",children:[p("h3",{children:"顧客情報編集"}),p("button",{onclick:"closeEditCustomerModal()",class:"btn btn-text",children:"✕"})]}),p("form",{id:"editCustomerForm",children:[p("input",{type:"hidden",id:"editCustomerId"}),p("div",{class:"form-group",children:[p("label",{children:"氏名 *"}),p("input",{type:"text",id:"editCustomerName",name:"name",required:!0})]}),p("div",{class:"form-group",children:[p("label",{children:"電話番号"}),p("input",{type:"tel",id:"editCustomerPhone",name:"phone"})]}),p("div",{class:"form-group",children:[p("label",{children:"メールアドレス"}),p("input",{type:"email",id:"editCustomerEmail",name:"email"})]}),p("div",{class:"form-group",children:[p("label",{children:"LINE User ID（任意）"}),p("input",{type:"text",id:"editCustomerLineUserId",name:"line_user_id",placeholder:"U1234567890abcdef..."}),p("small",{style:"color: #6b7280; font-size: 12px; display: block; margin-top: 4px;",children:"LINEで通知を受け取る場合は、User IDを入力してください"})]}),p("div",{class:"form-actions",children:[p("button",{type:"button",onclick:"closeEditCustomerModal()",class:"btn btn-secondary",children:"キャンセル"}),p("button",{type:"submit",class:"btn btn-primary",children:"保存"})]})]})]})}),p("script",{src:"/static/app.js"})]})));const Vt=new Tr,Cs=Object.assign({"/src/index.tsx":I});let Hr=!1;for(const[,e]of Object.entries(Cs))e&&(Vt.all("*",t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),Vt.notFound(t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),Hr=!0);if(!Hr)throw new Error("Can't import modules from ['/src/index.ts','/src/index.tsx','/app/server.ts']");export{Vt as default};
